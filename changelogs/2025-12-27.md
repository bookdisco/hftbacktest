# 改动总结 - 2025-12-27

## Collector 优雅关闭修复

### 问题
Collector 在收到 SIGTERM 信号时，gzip 文件没有被正确关闭，导致文件截断/损坏。

### 根本原因
iceoryx2 库会注册全局信号处理器，覆盖外部的信号处理库（如 signal-hook、ctrlc）。

### 解决方案
使用 iceoryx2 内置的 `SignalHandler::termination_requested()` 检测终止信号：

**collector/src/main.rs**:
```rust
use iceoryx2_bb_posix::signal::SignalHandler;

loop {
    // Check shutdown flag or iceoryx2's signal handler
    if shutdown.load(Ordering::SeqCst) || SignalHandler::termination_requested() {
        info!("Shutdown requested, exiting main loop...");
        break;
    }
    // ...
}
```

**collector/src/ipc_collector.rs**:
```rust
use iceoryx2::node::NodeWaitFailure;
use iceoryx2_bb_posix::signal::SignalHandler;

// In run() loop:
if SignalHandler::termination_requested() {
    info!("IPC collector received termination request via iceoryx2");
    self.shutdown.store(true, Ordering::SeqCst);
    break;
}

match self.node.wait(Duration::from_millis(100)) {
    Err(NodeWaitFailure::TerminationRequest) => {
        self.shutdown.store(true, Ordering::SeqCst);
        break;
    }
    // ...
}
```

**collector/src/file.rs** - 添加显式 flush 方法：
```rust
impl Writer {
    pub fn flush(&mut self) {
        for (symbol, mut rotating_file) in self.file.drain() {
            if let Some(encoder) = rotating_file.file.take() {
                encoder.finish();  // 正确关闭 gzip 流
            }
        }
    }
}
```

### 依赖变更
```toml
# collector/Cargo.toml
iceoryx2-bb-posix = "0.6.1"  # 新增，用于 SignalHandler
```

---

## Collector 实时数据格式改进

### 问题
之前 collector 直接写入 `.gz` 文件，由于 gzip 格式需要 trailer 字节才能正确读取，导致：
- Warmup 无法读取正在写入的文件
- 必须停止 collector 才能使用当天的数据

### 解决方案
改为写入 `.jsonl`（纯文本 JSON Lines），支持边写边读：

```
btcusdt_20251227.jsonl  <- 当前文件，可边写边读
btcusdt_20251226.gz     <- 昨天的文件，已压缩
```

### 实现
**collector/src/file.rs**:
- 当天数据写入 `.jsonl` 文件（使用 `BufWriter`）
- 日期轮换时，将昨天的 `.jsonl` 压缩为 `.gz`
- 启动时自动压缩前几天遗留的 `.jsonl` 文件

**strategies/obi_mm_rust/src/warmup.rs**:
- 新增 `load_warmup_events_jsonl()` 读取 `.jsonl` 文件
- 自动优先选择最新的 `.jsonl` 文件进行预热
- 支持读取正在被写入的文件（数据延迟仅几秒）

### 效果
```
Data freshness check passed. Age: 6 seconds  # 数据只有6秒旧！
```

---

## Factor Engine Warmup 模块

### 新增文件
- `strategies/obi_mm_rust/src/warmup.rs` - 从历史数据预热因子引擎

### 支持的数据格式
- `.jsonl` - 当前 collector 格式（可边写边读）
- `.gz` - 压缩的历史数据
- `.npz` - Numpy 格式（从数据转换器）

### 功能
- 读取 collector 收集的数据文件
- 解析 JSON 格式的 depthUpdate/trade 事件
- 构建订单簿并计算因子，使策略启动时因子状态已预热
- 支持处理截断/不完整的文件

---

## Connector 市价单支持修复

### 问题
Stop loss 发送 MARKET 单时被 Binance 拒绝，错误：
```
Parameter 'timeinforce' sent when not required.
```

### 根本原因
`connector/src/binancefutures/rest.rs` 中的 `submit_order` 函数总是发送 `price` 和 `timeInForce` 参数，但 MARKET 单不接受这些参数。

### 解决方案
只对 LIMIT 单发送 `price` 和 `timeInForce`：

```rust
// Market orders don't accept price parameter
if order_type != OrdType::Market {
    body.push_str("&price=");
    body.push_str(&format!("{price:.price_prec$}"));
}
body.push_str("&quantity=");
body.push_str(&format!("{qty:.5}"));
body.push_str("&type=");
body.push_str(order_type.as_ref());
// Market orders don't accept timeInForce parameter
if order_type != OrdType::Market {
    body.push_str("&timeInForce=");
    body.push_str(time_in_force.as_ref());
}
```

### 验证结果
Stop loss 成功执行：
- 持仓从 -0.006 变为 0.0
- 订单类型正确：`ty: Market, orig_type: Market`
- 无 price 参数：`price: 0.0`

---

## OBI MM 策略改进

### Python 回测工具
- `strategies/obi_mm/utils.py` - 新增数据处理工具函数
- `strategies/obi_mm/backtest.py` - 回测脚本更新

### Rust 策略
- 添加 warmup 支持
- 配置结构扩展
