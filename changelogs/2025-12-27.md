# 改动总结 - 2025-12-27

## Collector 优雅关闭修复

### 问题
Collector 在收到 SIGTERM 信号时，gzip 文件没有被正确关闭，导致文件截断/损坏。

### 根本原因
iceoryx2 库会注册全局信号处理器，覆盖外部的信号处理库（如 signal-hook、ctrlc）。

### 解决方案
使用 iceoryx2 内置的 `SignalHandler::termination_requested()` 检测终止信号：

**collector/src/main.rs**:
```rust
use iceoryx2_bb_posix::signal::SignalHandler;

loop {
    // Check shutdown flag or iceoryx2's signal handler
    if shutdown.load(Ordering::SeqCst) || SignalHandler::termination_requested() {
        info!("Shutdown requested, exiting main loop...");
        break;
    }
    // ...
}
```

**collector/src/ipc_collector.rs**:
```rust
use iceoryx2::node::NodeWaitFailure;
use iceoryx2_bb_posix::signal::SignalHandler;

// In run() loop:
if SignalHandler::termination_requested() {
    info!("IPC collector received termination request via iceoryx2");
    self.shutdown.store(true, Ordering::SeqCst);
    break;
}

match self.node.wait(Duration::from_millis(100)) {
    Err(NodeWaitFailure::TerminationRequest) => {
        self.shutdown.store(true, Ordering::SeqCst);
        break;
    }
    // ...
}
```

**collector/src/file.rs** - 添加显式 flush 方法：
```rust
impl Writer {
    pub fn flush(&mut self) {
        for (symbol, mut rotating_file) in self.file.drain() {
            if let Some(encoder) = rotating_file.file.take() {
                encoder.finish();  // 正确关闭 gzip 流
            }
        }
    }
}
```

### 依赖变更
```toml
# collector/Cargo.toml
iceoryx2-bb-posix = "0.6.1"  # 新增，用于 SignalHandler
```

---

## Factor Engine Warmup 模块

### 新增文件
- `strategies/obi_mm_rust/src/warmup.rs` - 从历史 .gz 数据文件预热因子引擎

### 功能
- 读取 collector 收集的 gzip 压缩数据文件
- 解析 JSON 格式的 depthUpdate/trade 事件
- 构建订单簿并计算因子，使策略启动时因子状态已预热
- 支持处理截断/损坏的 gz 文件（graceful handling）

### 配置
```toml
# obi_mm_testnet.toml
warmup_data_path = "/path/to/collected/data"
```

### 使用
```rust
// testnet.rs
if let Some(warmup_path) = &config.warmup_data_path {
    warmup_from_file(&warmup_path, &symbol, &mut depth, &mut factor)?;
}
```

---

## OBI MM 策略改进

### Python 回测工具
- `strategies/obi_mm/utils.py` - 新增数据处理工具函数
- `strategies/obi_mm/backtest.py` - 回测脚本更新

### Rust 策略
- 添加 warmup 支持
- 配置结构扩展
