# 改动总结 - 2025-12-26

## Factor Engine 和 OBI MM 策略

## 17. Factor Engine 和 OBI MM 策略迁移 (新增)

### 背景
将 Python/Numba 实现的 OBI 市场做市策略迁移到纯 Rust，以便实盘交易使用。创建了通用的流式因子计算框架 `factor-engine`。

### 新增 Crate: `factor-engine`

#### 目录结构
```
factor-engine/
├── Cargo.toml
├── src/
│   ├── lib.rs
│   ├── primitives.rs      # 流式计算基础组件
│   ├── combiner.rs        # 多因子组合器
│   └── factors/
│       ├── mod.rs         # Factor trait 定义
│       ├── obi.rs         # Order Book Imbalance 因子
│       ├── volatility.rs  # 波动率因子
│       └── stop_loss.rs   # 止损检查器
```

#### 核心组件

**primitives.rs** - O(1) 时间复杂度的流式计算：
```rust
/// 固定大小环形缓冲区
pub struct RingBuffer<T, const N: usize> { ... }

/// Welford 算法的滚动均值/标准差
pub struct WelfordRolling { ... }

/// 指数移动平均
pub struct EMA { ... }

/// 时间窗口队列
pub struct TimeWindowQueue { ... }
```

**factors/obi.rs** - Order Book Imbalance 因子：
```rust
pub struct OBIFactor {
    looking_depth: f64,
    tick_size: f64,
    roi_lb_tick: i64,
    roi_ub_tick: i64,
    welford: WelfordRolling,  // 用于 Z-score 标准化
    current_raw: f64,
    current_zscore: f64,
}

impl Factor for OBIFactor {
    fn update(...) -> f64;  // 返回 Z-score
    fn value(&self) -> f64;
    fn reset(&mut self);
}
```

**factors/volatility.rs** - 滚动波动率：
```rust
pub struct VolatilityFactor {
    interval_ns: i64,
    welford: WelfordRolling,
    last_price: f64,
    last_update_time: i64,
}
```

**factors/stop_loss.rs** - 止损检查器：
```rust
pub enum StopLossStatus {
    Normal,
    VolatilityTriggered,
    ChangeTriggered,
}

pub struct StopLossChecker {
    volatility_mean: f64,
    volatility_std: f64,
    change_mean: f64,
    change_std: f64,
    volatility_threshold: f64,  // Z-score 阈值
    change_threshold: f64,
    status: StopLossStatus,
}
```

### 新增 Crate: `obi-mm` (strategies/obi_mm_rust)

#### 目录结构
```
strategies/obi_mm_rust/
├── Cargo.toml
├── config.example.toml
├── src/
│   ├── lib.rs
│   ├── config.rs          # 策略配置
│   ├── strategy.rs        # 核心策略逻辑
│   ├── backtest.rs        # 回测二进制
│   └── live.rs            # 实盘二进制
```

#### 配置结构

```rust
pub struct StrategyConfig {
    pub global: GlobalConfig,
    pub params: StrategyParams,
    pub stop_loss: StopLossConfig,
}

pub struct GlobalConfig {
    pub order_qty: f64,       // 每单数量
    pub max_position: f64,    // 最大持仓
    pub grid_num: i32,        // 网格数量
    pub grid_interval: f64,   // 网格间距
    pub roi_lb: f64,          // ROI 下界
    pub roi_ub: f64,          // ROI 上界
}

pub struct StrategyParams {
    pub looking_depth: f64,   // OBI 计算深度
    pub window: i32,          // Z-score 窗口
    pub half_spread: f64,     // 半价差
    pub skew: f64,            // 持仓偏斜
    pub c1: f64,              // Alpha 系数
    pub power: f64,           // 波动率幂
    pub live_seconds: f64,    // 订单存活时间
    pub update_interval_ns: i64,     // 更新间隔
    pub volatility_interval_ns: i64, // 波动率更新间隔
}
```

#### 策略核心

```rust
pub struct ObiMmStrategy {
    pub obi_factor: OBIFactor,
    pub volatility_factor: VolatilityFactor,
    pub stop_loss: StopLossChecker,
    // ...
}

impl ObiMmStrategy {
    /// 策略更新，返回是否更新了订单
    pub fn update<MD>(&mut self, bot: &mut impl Bot<MD>, asset_no: usize) -> bool
    where
        MD: MarketDepth + L2MarketDepth;

    /// 计算 OBI 因子
    fn compute_obi<MD>(...) -> f64;

    /// 更新网格订单
    fn update_grid_orders<MD>(...);

    /// 执行止损
    fn execute_stop_loss<MD>(...);
}
```

### 使用示例

```bash
# 回测
cargo run --release --bin obi_mm_backtest -- \
  --data test_data/btcusdt/2024-11-16.npz \
  --tick-size 0.1 \
  --lot-size 0.001 \
  --output ./results

# 实盘 (需要 live feature 和 connector)
cargo run --release --bin obi_mm_live --features live -- \
  --config config.toml \
  --symbol BTCUSDT \
  --connector-name connector
```

### 回测结果示例 (4天: 2024-11-16 至 2024-11-19)

| 指标 | 值 |
|------|-----|
| 时长 | 96小时 (4天) |
| 交易次数 | 78,469 笔 |
| 交易量 | 784.69 BTC |
| 交易额 | $71,523,142 |
| 已实现盈亏 | -$6,928.46 |
| 手续费 | -$3,576.16 |
| 净盈亏 | -$11,428.02 |

**注意**：默认参数未针对 BTC 优化，需要进一步调参。

---

## 18. Tardis 转换器优化 (新增)

### Python vs Rust 一致性验证

使用 1000FLOKIUSDT 2024-11-16 数据测试：
- Python: 41,983,289 events
- Rust: 41,983,289 events
- **所有字段完全一致 ✓**

### 性能优化

创建了 `tardis_fast.rs` 优化版本：

| 优化项 | 说明 |
|--------|------|
| 零拷贝解析 | 直接用 `&str` 比较，避免 `to_string()` 分配 |
| 直接构造 Event | 跳过中间 `TradeRecord`/`DepthRecord` 结构体 |
| 更大 I/O 缓冲 | 8MB 缓冲区减少系统调用 |
| 内联解析函数 | `#[inline(always)]` 减少函数调用开销 |
| 复用行缓冲 | 单个 `String` 缓冲区避免重复分配 |

### 性能对比

| 版本 | 速度 | 耗时 |
|------|------|------|
| 原版 | 4.43M events/sec | 9.47s |
| 优化版 | 6.06M events/sec | 6.93s |
| **提升** | **1.37x** | **节省 2.55s** |

### 修复大文件支持

修复了 >4GB NPZ 文件写入问题：
```rust
let options = SimpleFileOptions::default()
    .compression_method(zip::CompressionMethod::Deflated)
    .compression_level(Some(6))
    .large_file(true);  // 添加大文件支持
```

### 新增文件
```
hftbacktest/src/data/tardis_fast.rs          # 优化版转换器
hftbacktest/examples/tardis_benchmark.rs     # 性能对比测试
```

### 修改文件
```
hftbacktest/src/data/mod.rs                  # 导出 convert_fast, convert_and_save_fast
hftbacktest/src/data/tardis.rs               # 添加 large_file(true)
hftbacktest/examples/tardis_convert.rs       # 默认使用优化版
```

---

## 19. Workspace 更新

### 新增 Crate

```toml
# Cargo.toml (workspace)
members = [
    # ... 原有成员 ...
    "factor-engine",           # 新增
    "strategies/obi_mm_rust",  # 新增
]
```

### 文件变更清单 (本次更新)

**新增文件:**
```
factor-engine/Cargo.toml
factor-engine/src/lib.rs
factor-engine/src/primitives.rs
factor-engine/src/combiner.rs
factor-engine/src/factors/mod.rs
factor-engine/src/factors/obi.rs
factor-engine/src/factors/volatility.rs
factor-engine/src/factors/stop_loss.rs
strategies/obi_mm_rust/Cargo.toml
strategies/obi_mm_rust/config.example.toml
strategies/obi_mm_rust/src/lib.rs
strategies/obi_mm_rust/src/config.rs
strategies/obi_mm_rust/src/strategy.rs
strategies/obi_mm_rust/src/backtest.rs
strategies/obi_mm_rust/src/live.rs
hftbacktest/src/data/tardis_fast.rs
hftbacktest/examples/tardis_benchmark.rs
scripts/convert_tardis_data.py
test_data/btcusdt/*.npz                      # 转换后的回测数据
```

**修改文件:**
```
Cargo.toml                                   # 添加新 crate 到 workspace
hftbacktest/src/data/mod.rs                  # 导出优化版转换器
hftbacktest/src/data/tardis.rs               # 大文件支持
hftbacktest/examples/tardis_convert.rs       # 使用优化版
```

---

## 20. OBI MM 策略重构：使用 Factor Engine (新增)

### 背景
将 OBI MM Rust 策略中的内联因子计算代码重构为使用 `factor-engine` crate，实现代码解耦和复用。

### 修改内容

#### `factor-engine/src/factors/obi.rs`
添加两个新方法以支持不同的深度数据访问模式：

```rust
/// 使用访问器函数更新 OBI 因子
/// 适用于 L2MarketDepth trait（如 HashMapMarketDepth）
#[inline]
pub fn update_with_accessor<F, G>(
    &mut self,
    best_bid_tick: i64,
    best_ask_tick: i64,
    mid_price: f64,
    bid_qty_at_tick: F,
    ask_qty_at_tick: G,
) -> f64
where
    F: Fn(i64) -> f64,
    G: Fn(i64) -> f64,
{
    // 使用闭包访问深度数据
    for price_tick in from_tick..upto_tick {
        sum_ask_qty += ask_qty_at_tick(price_tick);
    }
    // ... 计算 raw OBI 和 z-score
}

/// 直接使用原始 OBI 值更新
/// 适用于已经外部计算了深度差值的场景
#[inline]
pub fn update_raw(&mut self, raw_obi: f64) -> f64 {
    self.current_raw = raw_obi;
    self.welford.update(raw_obi);
    self.current_zscore = self.welford.zscore(raw_obi);
    self.current_zscore
}
```

#### `strategies/obi_mm_rust/src/strategy.rs`
重构策略以使用 factor-engine：

**移除的代码：**
- `roi_lb_tick: i64` 字段
- `roi_ub_tick: i64` 字段
- `obi_welford: WelfordRolling` 字段
- `compute_obi()` 方法（约 40 行）

**修改后的结构体：**
```rust
pub struct ObiMmStrategy {
    pub global: GlobalConfig,
    pub params: StrategyParams,
    /// OBI factor from factor-engine (O(1) z-score computation)
    pub obi_factor: OBIFactor,
    /// Volatility factor from factor-engine (O(1) rolling std)
    pub volatility_factor: VolatilityFactor,
    /// Stop loss checker from factor-engine
    pub stop_loss: StopLossChecker,
    last_check_period: i64,
    last_change_period: i64,
    last_price: f64,
    minute_change: f64,
    tick_size: f64,
}
```

**OBI 计算方式变更：**
```rust
// 旧代码：内联计算
let alpha = self.compute_obi(depth, best_bid_tick, best_ask_tick, mid_price);

// 新代码：使用 factor-engine
let depth = bot.depth(asset_no);
let alpha = self.obi_factor.update_with_accessor(
    best_bid_tick,
    best_ask_tick,
    mid_price,
    |tick| depth.bid_qty_at_tick(tick),
    |tick| depth.ask_qty_at_tick(tick),
);
```

**reset() 方法简化：**
```rust
pub fn reset(&mut self) {
    self.last_check_period = -1;
    self.last_change_period = -1;
    self.last_price = 0.0;
    self.minute_change = 0.0;
    self.obi_factor.reset();        // 委托给 factor-engine
    self.volatility_factor.reset();
    self.stop_loss.reset();
}
```

### 复杂度说明

OBI 因子计算分为两部分：

| 部分 | 复杂度 | 说明 |
|------|--------|------|
| 深度扫描 | O(d) | d = 扫描的 tick 数量 ≈ 900 (0.1% 深度) |
| Z-score 标准化 | O(1) | 使用 Welford 在线算法 |

**总复杂度**: O(d) + O(1) = O(d)

Welford 算法实现了 O(1) 的滚动均值/标准差计算，无论窗口大小是 3600 还是 36000。

### 验证结果

重构后回测结果与重构前完全一致：

| 指标 | 重构前 | 重构后 |
|------|--------|--------|
| Final Position | -0.0300 | -0.0300 |
| Balance | 845.6010 | 845.6010 |
| Fee | -870.1369 | -870.1369 |

### 文件变更

**修改文件:**
```
factor-engine/src/factors/obi.rs             # 添加 update_with_accessor, update_raw 方法
strategies/obi_mm_rust/src/strategy.rs       # 移除内联计算，使用 factor-engine
```

## Order Recording Module (order-recorder)

### 概述

新增 order-recorder crate，用于记录实盘交易活动到 ClickHouse 进行分析和监控。

### 功能特性

- **IPC 通信**: 使用 iceoryx2 实现零拷贝进程间通信
- **ClickHouse 存储**: 异步批量写入 ClickHouse 时序数据库
- **Order Hook 集成**: `OrderHookContext` 与 `LiveBotBuilder::order_recv_hook()` 集成
- **延迟跟踪**: 记录订单往返延迟 (local_timestamp -> exch_timestamp)
- **成交检测**: 自动从订单状态变化中检测成交
- **持仓快照**: 定期记录持仓和盈亏快照

### 架构

```
Strategy (Bot)  --IPC-->  order-recorder  --HTTP-->  ClickHouse
     |                         |
     v                         v
OrderHookContext          RecordingService
     |                         |
     v                         v
RecordingPublisher        ClickHouseWriter
```

### 文件结构

- `order-recorder/src/events.rs` - IPC 事件类型 (OrderUpdate, FillEvent, PositionSnapshot, StrategyStatus)
- `order-recorder/src/service.rs` - Recording 服务 (IPC 订阅者) 和 RecordingPublisher
- `order-recorder/src/writer.rs` - 异步 ClickHouse 写入器（带批处理）
- `order-recorder/src/convert.rs` - hftbacktest::Order 到 recording 事件的转换
- `order-recorder/src/hook.rs` - 公共 OrderHookContext 供策略集成
- `order-recorder/src/main.rs` - 独立的 recording 服务二进制

### 使用方法

```rust
use order_recorder::{StrategyState, hook::create_order_hook};

// 创建 hook context (如果服务不可用则返回 None)
let hook_ctx = create_order_hook(
    "hft_recording",           // IPC 服务名
    "my_strategy".to_string(), // 策略 ID
    "btcusdt".to_string(),     // 交易对
    0.1,                       // tick_size
);

// 用于 LiveBotBuilder
if let Some(ctx) = hook_ctx.clone() {
    builder = builder.order_recv_hook(move |prev, new| {
        ctx.handle_order(prev, new);
        Ok(())
    });
}

// 随时发布状态/持仓
if let Some(ref ctx) = hook_ctx {
    ctx.publish_status(StrategyState::Running, "Running".to_string());
    ctx.publish_position(position, avg_price, mid_price, unrealized_pnl, realized_pnl);
}
```

### ClickHouse 表结构

```sql
-- 订单表
CREATE TABLE hft.orders (
    order_id UInt64, symbol String, side Enum8, price Float64, qty Float64,
    status Enum8, create_time DateTime64(9), update_time DateTime64(9),
    exch_time DateTime64(9), leaves_qty Float64, exec_qty Float64,
    exec_price Float64, latency_ns Int64, strategy_id String
) ENGINE = MergeTree() ORDER BY (strategy_id, symbol, update_time);

-- 成交表
CREATE TABLE hft.fills (
    fill_id UInt64, order_id UInt64, symbol String, side Enum8,
    price Float64, qty Float64, fee Float64, is_maker UInt8,
    exch_time DateTime64(9), local_time DateTime64(9),
    slippage_bps Float64, strategy_id String
) ENGINE = MergeTree() ORDER BY (strategy_id, symbol, local_time);

-- 持仓表
CREATE TABLE hft.positions (
    timestamp DateTime64(9), symbol String, position Float64,
    avg_price Float64, unrealized_pnl Float64, realized_pnl Float64,
    strategy_id String
) ENGINE = MergeTree() ORDER BY (strategy_id, symbol, timestamp);

-- 策略状态表
CREATE TABLE hft.strategy_status (
    timestamp DateTime64(9), strategy_id String, status UInt8, message String
) ENGINE = MergeTree() ORDER BY (strategy_id, timestamp);
```

### 延迟查询示例

```sql
-- 延迟统计
SELECT
    avg(latency_ns)/1000000 as avg_ms,
    min(latency_ns)/1000000 as min_ms,
    quantile(0.5)(latency_ns)/1000000 as p50_ms,
    quantile(0.95)(latency_ns)/1000000 as p95_ms
FROM hft.orders WHERE latency_ns > 0 AND latency_ns < 1000000000;

-- 按状态统计订单
SELECT status, count() FROM hft.orders GROUP BY status;
```

### OBI MM 策略更新

#### Testnet 二进制

- `strategies/obi_mm_rust/src/testnet.rs` - 新的 testnet 交易二进制（带订单录制）
- 移除 `strategies/obi_mm_rust/src/live.rs` (由 testnet.rs 替代)

#### 配置文件

- `examples/testnet/config/obi_mm_testnet.toml` - OBI MM testnet 配置
- `examples/testnet/config/obi_mm_btcusdt.toml` - BTCUSDT 特定配置
- `examples/testnet/scripts/start_obi_mm.sh` - OBI MM 策略启动脚本

### Workspace 更新

- 在根 `Cargo.toml` 中添加 `order-recorder` 到 workspace members
- 更新 `strategies/obi_mm_rust/Cargo.toml` 依赖 `order-recorder`
